name: Build and Release

on:
  push:
    tags:
      - 'v*'  # ç•¶æ¨é€ä»¥ v é–‹é ­çš„ tag æ™‚è§¸ç™¼ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build executable with PyInstaller
      run: |
        pyinstaller yzuCourseBot.spec
        
    - name: Rename executable
      run: |
        cd dist
        dir
        
    - name: Create release notes
      id: release_notes
      run: |
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
        echo "## å…ƒæ™ºå¤§å­¸é¸èª²æ©Ÿå™¨äºº ${{ github.ref_name }}" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸ“¥ ä¸‹è¼‰èªªæ˜" >> $GITHUB_ENV
        echo "**åªéœ€ä¸‹è¼‰ \`å…ƒæ™ºé¸èª²æ©Ÿå™¨äºº.exe\` å³å¯å®Œæ•´ä½¿ç”¨ï¼Œç„¡éœ€å…¶ä»–æª”æ¡ˆï¼**" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸš€ ä½¿ç”¨æ–¹å¼" >> $GITHUB_ENV
        echo "1. ä¸‹è¼‰ \`å…ƒæ™ºé¸èª²æ©Ÿå™¨äºº.exe\`" >> $GITHUB_ENV
        echo "2. æ”¾åœ¨ä»»æ„è³‡æ–™å¤¾ï¼Œé›™æ“ŠåŸ·è¡Œ" >> $GITHUB_ENV
        echo "3. åœ¨åœ–å½¢ä»‹é¢ä¸­è¼¸å…¥å¸³è™Ÿã€å¯†ç¢¼ã€èª²ç¨‹æ¸…å–®" >> $GITHUB_ENV
        echo "4. é»æ“Šã€Œé–‹å§‹é¸èª²ã€æŒ‰éˆ•" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸ“‹ èª²ç¨‹æ¸…å–®æ ¼å¼" >> $GITHUB_ENV
        echo "æ¯è¡Œä¸€å€‹èª²ç¨‹ï¼Œæ ¼å¼ï¼š\`éƒ¨é–€ä»£ç¢¼,èª²ç¨‹ä»£ç¢¼\`" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "ç¯„ä¾‹ï¼š" >> $GITHUB_ENV
        echo "\`\`\`" >> $GITHUB_ENV
        echo "312,EEB219A" >> $GITHUB_ENV
        echo "312,CS201B" >> $GITHUB_ENV
        echo "\`\`\`" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸ’» ç³»çµ±éœ€æ±‚" >> $GITHUB_ENV
        echo "- Windows 10/11" >> $GITHUB_ENV
        echo "- ç¶²è·¯é€£ç·š" >> $GITHUB_ENV
        echo "- **ç„¡éœ€å®‰è£ Python æˆ–ä»»ä½•å…¶ä»–è»Ÿé«”**" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### âš ï¸ æ³¨æ„äº‹é …" >> $GITHUB_ENV
        echo "- é¦–æ¬¡åŸ·è¡Œå¯èƒ½éœ€è¦ 10-30 ç§’å•Ÿå‹•ï¼ˆè§£å£“ç¸®å…§éƒ¨è³‡æºï¼‰" >> $GITHUB_ENV
        echo "- ç¨‹å¼åŸ·è¡Œæ™‚æœƒåœ¨ç•¶å‰ç›®éŒ„ä¸‹ç”¢ç”Ÿ \`captcha.png\` è‡¨æ™‚æª”æ¡ˆ" >> $GITHUB_ENV
        echo "- è«‹ç¢ºä¿ç¶²è·¯é€£ç·šæ­£å¸¸" >> $GITHUB_ENV
        echo "- è«‹åœ¨é¸èª²æ™‚é–“å…§ä½¿ç”¨" >> $GITHUB_ENV
        echo "- Windows Defender å¯èƒ½æœƒè­¦å‘Šï¼Œè«‹é¸æ“‡ã€Œä»è¦åŸ·è¡Œã€" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸ“„ é™„åŠ æª”æ¡ˆ" >> $GITHUB_ENV
        echo "- \`ä½¿ç”¨èªªæ˜.md\`ï¼šè©³ç´°èªªæ˜æ–‡ä»¶ï¼ˆå¯é¸ä¸‹è¼‰ï¼‰" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
      shell: bash
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/å…ƒæ™ºé¸èª²æ©Ÿå™¨äºº.exe
          ä½¿ç”¨èªªæ˜.md
        body: ${{ env.RELEASE_NOTES }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: YZU-Course-Bot-${{ github.ref_name }}
        path: dist/å…ƒæ™ºé¸èª²æ©Ÿå™¨äºº.exe

